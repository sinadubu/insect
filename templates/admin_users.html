<!DOCTYPE html>
<html class="dark" lang="ko">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>계정 관리 - Insect AI</title>
    <!-- 외부 리소스 로드: Tailwind CSS, 폰트, 아이콘 -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link
        href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300..700&family=Noto+Sans+KR:wght@100..900&display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
        rel="stylesheet" />
    <script>
        // Tailwind CSS 설정: 다크모드 및 커스텀 색상 테마 정의
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#13b6ec",
                        "background-light": "#f6f8f8",
                        "background-dark": "#101d22",
                    },
                    fontFamily: {
                        display: ["Space Grotesk", "Noto Sans KR", "sans-serif"],
                    },
                },
            },
        }
    </script>
    <style>
        /* 아이콘 스타일 설정 */
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
    </style>
</head>

<body class="bg-background-light dark:bg-background-dark font-display">
    <!-- 메인 레이아웃 컨테이너 -->
    <div class="min-h-screen max-w-5xl mx-auto p-4">
        <!-- 헤더 영역: 페이지 제목 및 네비게이션 버튼 -->
        <header class="flex items-center justify-between mb-6">
            <h1 class="text-xl font-bold text-slate-900 dark:text-white">계정 관리</h1>
            <div class="flex items-center gap-2 text-xs">
                <!-- 대시보드 이동 버튼 -->
                <a href="{{ url_for('dashboard_page') }}"
                    class="inline-flex items-center gap-1 rounded-full border border-slate-400 px-3 py-1 text-[11px] text-slate-800 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-800">
                    <span class="material-symbols-outlined text-sm">dashboard</span>
                    대시보드
                </a>
                <!-- 로그아웃 버튼 -->
                <a href="{{ url_for('logout') }}"
                    class="inline-flex items-center gap-1 rounded-full border border-slate-400 px-3 py-1 text-[11px] text-slate-800 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-800">
                    <span class="material-symbols-outlined text-sm">logout</span>
                    로그아웃
                </a>
            </div>
        </header>

        <!-- 메인 콘텐츠 영역: 사용자 관리 패널 -->
        <div
            class="rounded-xl bg-white/80 p-4 shadow-sm ring-1 ring-slate-200/60 dark:bg-slate-900/80 dark:ring-slate-800">
            <div class="mb-3 flex items-center justify-between">
                <h2 class="text-sm font-semibold text-slate-800 dark:text-slate-100">
                    사용자 목록
                </h2>
                <!-- 안내 문구 -->
                <p class="text-[11px] text-slate-500 dark:text-slate-400">
                    계정 삭제 시, 해당 사용자가 업로드한 영상도 함께 삭제됩니다.
                </p>
            </div>

            <!-- 사용자 목록 테이블 시작 -->
            <table class="min-w-full text-xs text-left text-slate-700 dark:text-slate-200">
                <thead
                    class="border-b border-slate-200 text-[11px] uppercase text-slate-500 dark:border-slate-700 dark:text-slate-400">
                    <tr>
                        <th class="px-3 py-2">ID</th>
                        <th class="px-3 py-2">이름</th>
                        <th class="px-3 py-2">이메일</th>
                        <th class="px-3 py-2 text-center">Role</th>
                        <th class="px-3 py-2 text-center">영상 수</th>
                        <th class="px-3 py-2 text-center">생성일</th>
                        <th class="px-3 py-2 text-center">관리</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- 사용자 데이터 반복 출력 -->
                    {% for u in users %}
                    <tr class="border-b border-slate-100 last:border-0 dark:border-slate-800">
                        <td class="px-3 py-2 font-mono text-[10px] text-slate-500">
                            {{ u._id }}
                        </td>
                        <td class="px-3 py-2">
                            {{ u.name }}
                        </td>
                        <td class="px-3 py-2">
                            {{ u.email }}
                        </td>
                        <td class="px-3 py-2 text-center">
                            <!-- 역할(Role) 표시: 관리자와 일반 사용자의 배지 스타일 구분 -->
                            <span class="rounded-full px-2 py-0.5 text-[10px]
                           {% if u.role == 'admin' %}
                             bg-red-100 text-red-600 dark:bg-red-900/30 dark:text-red-300
                           {% else %}
                             bg-slate-100 text-slate-600 dark:bg-slate-800/70 dark:text-slate-200
                           {% endif %}">
                                {{ u.role }}
                            </span>
                        </td>
                        <td class="px-3 py-2 text-center">
                            {{ u.video_count or 0 }}
                        </td>
                        <td class="px-3 py-2 text-[10px] text-slate-500 text-center">
                            {{ u.created_at_str or '' }}
                        </td>
                        <td class="px-3 py-2 text-center">
                            {% if u.role != 'admin' %}
                            <!-- 계정 삭제 버튼 (일반 사용자만 표시) -->
                            <button type="button"
                                class="inline-flex items-center gap-1 rounded-full border border-rose-400/70 px-3 py-1 text-[10px] font-semibold text-rose-600 hover:bg-rose-50 dark:border-rose-500/60 dark:text-rose-300 dark:hover:bg-rose-950/40"
                                data-action="delete-user" data-user-id="{{ u._id }}" data-user-name="{{ u.name }}"
                                data-video-count="{{ u.video_count or 0 }}">
                                <span class="material-symbols-outlined text-xs">delete</span>
                                삭제
                            </button>
                            {% else %}
                            <span class="text-[10px] text-slate-400 dark:text-slate-500">
                                (관리자)
                            </span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <!-- 작업 결과 메시지 표시 영역 -->
            <div id="admin-message" class="mt-3 text-[11px] text-slate-500 dark:text-slate-400"></div>
        </div>
    </div>

    <!-- 스크립트: 기능 구현 -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const messageEl = document.getElementById("admin-message");

            // 메시지 표시 함수: 성공/실패 여부에 따라 스타일 적용
            function setMessage(text, isError = false) {
                if (!messageEl) return;
                messageEl.textContent = text;
                if (isError) {
                    messageEl.classList.remove("text-slate-500", "dark:text-slate-400");
                    messageEl.classList.add("text-rose-600", "dark:text-rose-300");
                } else {
                    messageEl.classList.remove("text-rose-600", "dark:text-rose-300");
                    messageEl.classList.add("text-slate-500", "dark:text-slate-400");
                }
            }

            // 모든 삭제 버튼에 클릭 이벤트 리스너 등록
            document.querySelectorAll("[data-action='delete-user']").forEach((btn) => {
                btn.addEventListener("click", async () => {
                    const userId = btn.getAttribute("data-user-id");
                    const userName = btn.getAttribute("data-user-name") || "";
                    const videoCount = btn.getAttribute("data-video-count") || "0";

                    // 삭제 확인 대화상자 표시
                    const ok = window.confirm(
                        `정말로 이 계정을 삭제하시겠습니까?\n\n이름: ${userName}\n영상 개수: ${videoCount}개\n\n해당 사용자가 업로드한 영상도 함께 삭제됩니다.`
                    );
                    if (!ok) return;

                    try {
                        // 서버에 계정 삭제 요청 전송
                        const res = await fetch(`/admin/users/${userId}`, {
                            method: "DELETE",
                        });

                        let data = {};
                        try {
                            data = await res.json();
                        } catch (_) { }

                        // 요청 실패 시 처리
                        if (!res.ok) {
                            const msg = data.error || "삭제 중 오류가 발생했습니다.";
                            setMessage(msg, true);
                            alert(msg);
                            return;
                        }

                        // 요청 성공 시 처리
                        const deletedVideos = data.deleted_videos ?? 0;
                        const successMsg = `계정이 삭제되었습니다. (삭제된 영상: ${deletedVideos}개)`;
                        setMessage(successMsg, false);
                        alert(successMsg);

                        // 목록 갱신을 위해 페이지 간단 새로고침
                        window.location.reload();
                    } catch (err) {
                        console.error(err);
                        setMessage("서버와 통신 중 오류가 발생했습니다.", true);
                        alert("서버와 통신 중 오류가 발생했습니다.");
                    }
                });
            });
        });
    </script>
</body>

</html>